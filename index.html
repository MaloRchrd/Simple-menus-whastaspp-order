<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Menu</title>

<style>
html { scroll-behavior: smooth; }
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f6f6f6;
  padding-bottom: 200px;
}

h1 { text-align: center; }

.category-nav {
  position: sticky;
  top: 0;
  background: white;
  display: flex;
  gap: 10px;
  padding: 10px;
  overflow-x: auto;
  border-bottom: 1px solid #ddd;
  z-index: 1000;
}

.category-nav a {
  padding: 8px 14px;
  background: #eee;
  border-radius: 20px;
  text-decoration: none;
  color: #333;
  white-space: nowrap;
}

.category {
  padding: 15px;
}

.category h2 {
  border-left: 4px solid #25D366;
  padding-left: 10px;
}

.menu-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 15px;
}

.card {
  background: white;
  border-radius: 14px;
  box-shadow: 0 8px 18px rgba(0,0,0,.08);
  overflow: hidden;
  text-align: center;
}

.card img {
  width: 100%;
  height: 120px;
  object-fit: cover;
}

.qty {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 10px;
}

.qty button {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: none;
  background: #25D366;
  color: white;
  font-size: 18px;
}

/* PANIER */
.cart-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  max-width: 600px;
  margin: auto;
  z-index: 2000;
}

.cart-header {
  background: #25D366;
  color: white;
  padding: 14px;
  display: flex;
  justify-content: space-between;
  cursor: pointer;
  border-radius: 16px 16px 0 0;
}

.cart-body {
  background: white;
  max-height: 0;
  overflow: hidden;
  transition: max-height .3s ease;
  padding: 0 15px;
}

.cart-body.open {
  max-height: 500px;
  padding: 15px;
}

.whatsapp-btn {
  width: 100%;
  background: #25D366;
  color: white;
  border: none;
  padding: 12px;
  border-radius: 10px;
  margin-top: 10px;
}

.whatsapp-btn:disabled {
  background: #ccc;
}

.closed {
  color: red;
  font-weight: bold;
}
</style>
</head>

<body>

<h1 id="restaurant-name">üçΩÔ∏è Menu</h1>
<p id="open-status" style="text-align:center;"></p>

<div class="category-nav" id="category-nav"></div>
<div id="menu"></div>

<!-- PANIER -->
<div class="cart-container">
  <div class="cart-header" id="cart-toggle">
    üõí Mon panier <span id="arrow">‚¨ÜÔ∏è</span>
  </div>
  <div class="cart-body" id="cart-body">
    <pre id="cart-items">Aucun article</pre>
    <p id="total"></p>

    <label>
      <input type="checkbox" id="asap"> D√®s que possible ‚è±Ô∏è
    </label>

    <input type="datetime-local" id="datetime" style="width:100%;margin-top:8px">

    <button class="whatsapp-btn" id="send">Envoyer WhatsApp üì≤</button>
  </div>
</div>

<script>
/* ===== CONFIG AIRTABLE ===== */
const BASE_ID = "appXXXXXXXX";
const API_KEY = "patXXXXXXXX";
const headers = { Authorization: `Bearer ${API_KEY}` };

const params = new URLSearchParams(window.location.search);
const slug = params.get("resto");

let phoneNumber = "";
let openingHours = [];
const cards = [];

/* ===== UTILS ===== */
function timeToMinutes(t) {
  const [h,m] = t.split(':').map(Number);
  return h*60+m;
}
function todayName() {
  return new Date().toLocaleDateString('en-US',{weekday:'long'});
}

/* ===== CHECK OPEN ===== */
function checkOpen() {
  const now = new Date();
  const nowMin = now.getHours()*60+now.getMinutes();
  const today = todayName();

  const slots = openingHours.filter(h =>
    h.fields.day === today && h.fields.open
  );

  for (const s of slots) {
    const o = timeToMinutes(s.fields.open_time);
    const c = timeToMinutes(s.fields.close_time);
    if (nowMin >= o && nowMin <= c) return { open:true };
  }

  return { open:false, next: slots[0]?.fields.open_time };
}

/* ===== LOAD DATA ===== */
async function loadData() {
  // Restaurant
  const resto = (await fetch(
    `https://api.airtable.com/v0/${BASE_ID}/Restaurants?filterByFormula=slug="${slug}"`,
    { headers }
  ).then(r=>r.json())).records[0].fields;

  document.getElementById("restaurant-name").textContent = resto.name;
  phoneNumber = resto.phone;

  // Categories
  const categories = (await fetch(
    `https://api.airtable.com/v0/${BASE_ID}/Categories?sort[0][field]=order`,
    { headers }
  ).then(r=>r.json())).records;

  // Items
  const items = (await fetch(
    `https://api.airtable.com/v0/${BASE_ID}/MenuItems?filterByFormula=available=1`,
    { headers }
  ).then(r=>r.json())).records;

  // Hours
  openingHours = (await fetch(
    `https://api.airtable.com/v0/${BASE_ID}/OpeningHours`,
    { headers }
  ).then(r=>r.json())).records;

  renderMenu(categories, items);
  handleOpenStatus();
}

/* ===== RENDER ===== */
function renderMenu(categories, items) {
  const nav = document.getElementById("category-nav");
  const menu = document.getElementById("menu");

  categories.forEach(cat => {
    nav.innerHTML += `<a href="#${cat.id}">${cat.fields.name}</a>`;

    const section = document.createElement("div");
    section.className = "category";
    section.id = cat.id;
    section.innerHTML = `<h2>${cat.fields.name}</h2><div class="menu-grid"></div>`;
    const grid = section.querySelector(".menu-grid");

    items.filter(i=>i.fields.category?.includes(cat.id)).forEach(i=>{
      const card = document.createElement("div");
      card.className="card";
      card.dataset.name=i.fields.name;
      card.dataset.price=i.fields.price;
      card.innerHTML=`
        <img src="${i.fields.photo?.[0]?.url||''}">
        <h3>${i.fields.name}</h3>
        <p>${i.fields.price.toFixed(2)} ‚Ç¨</p>
        <div class="qty">
          <button class="minus">‚àí</button>
          <input type="number" value="0" min="0">
          <button class="plus">+</button>
        </div>`;
      grid.appendChild(card);
      cards.push(card);
    });
    menu.appendChild(section);
  });

  bindCart();
}

/* ===== CART ===== */
function bindCart() {
  const cartItems = document.getElementById("cart-items");
  const totalDiv = document.getElementById("total");
  const cartBody = document.getElementById("cart-body");
  const arrow = document.getElementById("arrow");

  function update() {
    let txt="",total=0;
    cards.forEach(c=>{
      const q=+c.querySelector("input").value;
      const p=+c.dataset.price;
      if(q){
        txt+=`‚Ä¢ ${c.dataset.name} x${q} = ${(p*q).toFixed(2)}‚Ç¨\n`;
        total+=p*q;
      }
    });
    cartItems.textContent=txt||"Aucun article";
    totalDiv.textContent=total?`üí∞ Total : ${total.toFixed(2)} ‚Ç¨`:"";
    if(total){cartBody.classList.add("open");arrow.textContent="‚¨áÔ∏è";}
  }

  cards.forEach(c=>{
    c.querySelector(".plus").onclick=()=>{c.querySelector("input").value++;update();}
    c.querySelector(".minus").onclick=()=>{if(c.querySelector("input").value>0){c.querySelector("input").value--;update();}}
  });

  document.getElementById("cart-toggle").onclick=()=>{
    cartBody.classList.toggle("open");
    arrow.textContent=cartBody.classList.contains("open")?"‚¨áÔ∏è":"‚¨ÜÔ∏è";
  };

  document.getElementById("send").onclick=()=>{
    if(!totalDiv.textContent)return alert("Ajoute un plat üòâ");
    let msg=`üõí *Commande*\n\n${cartItems.textContent}\n${totalDiv.textContent}`;
    if(asap.checked)msg+="\n‚è±Ô∏è D√®s que possible";
    else if(datetime.value)msg+=`\nüïí Pour : ${datetime.value.replace('T',' ')}`;
    window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(msg)}`);
  };
}

/* ===== OPEN STATUS ===== */
function handleOpenStatus() {
  const status = checkOpen();
  const btn = document.getElementById("send");
  const txt = document.getElementById("open-status");

  if(!status.open){
    btn.disabled=true;
    txt.innerHTML=`‚õî Restaurant ferm√© ${status.next?`‚Äì ouvre √† ${status.next}`:''}`;
    txt.className="closed";
    asap.disabled=true;
  } else {
    txt.innerHTML="üü¢ Restaurant ouvert";
  }
}

loadData();
</script>

</body>
</html>
